{"text": "---\nid: 4119\nscope: auth\nstate: draft\ncreated: 2022-09-09\n---\n\n# mTLS Token Binding\n\nToken binding allows issuing Google access tokens that are bound to mTLS\ncredentials. The advantage of such mTLS bound tokens is that they are meant to\nonly be used over secure channels established via mTLS credentials they are\nbound to. Therefore, using bound tokens is more secure than bearer tokens which\ncan be stolen and adversarially replayed.\n\nThis AIP describes the flow of (1) obtaining access tokens bound to X.509\ncertificate identities, called identity-bound tokens and (2) how to use them to\naccess Google APIs using the Google auth libraries.\n\n**Note:** Because this AIP describes guidance and requirements in a\nlanguage-neutral way, it uses generic terminology which may be imprecise or\ninappropriate in certain languages or environments.\n\n## Guidance\n\nIf users enable token binding, they **should** do so via [ADC][0]. This section\ndescribes the general guidance of supporting such tokens.\n\n### Prerequisites\n\nIdentity-bound access tokens require that the clients have\n[X.509 SPIFFE Verifiable Identity Documents][1] (SVIDs). [Mutual Authentication\nUsing Workload Credentials][2] describes how such SVIDs are provisioned in\nGoogle Cloud.\n\nAdditionally, identity-bound access tokens tokens require configuring a workload\nidentity pool and identity provider with Google Cloud's IAM. The instructions on\nhow to do this are out of scope of this AIP.\n\n### Using mTLS Token Binding\n\nThe auth libraries **must** support the following values in the\n**\"~/.config/gcloud/certificate_config.json\"** configuration file. Note that the\ndefault location of this file can be changed using the\n`GOOGLE_API_CERTIFICATE_CONFIG` environment variable.\n\n```json\n{\n  \"version\": 1\n  \"cert_configs\": {\n    \"workload\": {\n      \"cert_path\": \"path/to/cert/file\"\n      \"key_path\": \"path/to/key/file\"\n      \"workload_identity_provider\": \"...\"\n      \"authenticate_as_identity_type\": \"gsa/native\"\n      \"service_account_email\": \"...\"\n    },\n    \"keychain\": {\n      ...\n    },\n    \"pkcs11\": {\n      ...\n    },\n    \"windows\": {\n      ...\n    },\n  },\n  \"libs\": {\n   ...\n  }\n}\n```\n\nThe following lists the fields relevant to mTLS token binding configuration:\n\n- **\"workload_identity_provider\"**: The specified value will be used to\npopulate the request to Security Token Service (STS) to request\nidentity-bound access tokens. This value refers to the fully qualified name\nof the workload identity pool and identity provider configured in IAM. The\nspecified value **must** be of the following format.\n\n```\n\"workload_identity_provider\":\"//iam.googleapis.com/projects/<project_number>/locations/global/workloadIdentityPools/<pool_identifier>/providers/<provider_identifier>\"\n```\n\n- **\"authenticate_as_identity_type\"**: This field specifies what identity is\nused to authenticate to Google APIs. The value can be set to `gsa` or\n`native`, where `gsa` is the GCP service account of the workload, e.g., the\nGCP service account of a GCE VM, and `native` is the native workload\nidentity, e.g., the GKE pod kubernetes service account. If not specified,\nthe default value is `gsa`.\n\n- **\"service_account_email\"**: If set, the specified value will be used to\npopulate the request to the IAM Credentials service to request\nidentity-bound access tokens. This value refers to the service account email\nto be used for resource access. If not set, the service account email will\nbe determined automatically by querying the following Metadata Service\nendpoint:\n`http://metadata/computeMetadata/v1/instance/service-accounts/default/email`.\nThe value of this field is only relevant if\n**\"authenticate_as_identity_type\"** is set to `gsa`.\n\nThe description of the **\"cert_path\"** and **\"key_path\"** fields can be found in\n[Mutual Authentication Using Workload Credentials][2].\n\nTo enable using token binding when communicating with Google APIs the following\nconditions are required:\n\n- [Mutual Authentication Using Workload Credentials][2] **must** be enabled.\n\n- The **\"workload_identity_provider\"** **must** be present,\n**\"authenticate_as_identity_type\"** __may__ be set and\n**\"service_account_email\"** __may__ be set in the **\"workload\"**\nsection of the **\"~/.config/gcloud/certificate_config.json\"** configuration\nfile.\n\n### Expected Behavior\n\nTo support the usage of identity-bound access tokens, the auth libraries\n**must** follow the steps below when sending requests to Google APIs:\n\n1. Connect to the mTLS endpoint of the [STS API][3] using the workload\ncredentials provisioned as described in [Mutual Authentication Using\nWorkload Credentials][2]. This endpoint **must** be\n`sts.mtls.googleapis.com`.\n\n1. Send an HTTP request to STS\u2019s [ExchangeToken][5] method requesting an\nidentity-bound token using the information in the\n**\"workload_identity_provider\"** field in the\n**\"~/.config/gcloud/certificate_config.json\"** configuration file. The\nscope of the requested token **must** be\n`https://www.googleapis.com/auth/iam`.\n\n1. Connect to the mTLS endpoint of the [IAM Credentials Service API][4] using\nthe workload credentials provisioned as described in [Mutual Authentication\nUsing Workload Credentials][2]. This endpoint **must** be\n`iamcredentials.mtls.googleapis.com`.\n\n1. If **\"authenticate_as_identity_type\"** is set to `gsa`, send an HTTP\nrequest to the IAM Credentials Service\u2019s [GenerateAccessToken][6] method\nrequesting an identity bound token asserting the service account email in\nthe **\"service_account_email\"** field in the\n**\"~/.config/gcloud/certificate_config.json\"** configuration file. The\nscope of this token **must** be the same scope defined by the user for\naccessing the requested Google API.\n\n1. Attach the returned token in Step 4 to the request. Note that this request\n**must** be sent over an mTLS channel using the same workload credentials\nin Step 1.\n\n<!-- prettier-ignore-start -->\n[0]: https://google.aip.dev/auth/4110\n[1]: https://github.com/spiffe/spiffe/blob/main/standards/X509-SVID.md\n[2]: https://google.aip.dev/auth/4118\n[3]: https://cloud.google.com/iam/docs/reference/sts/rest\n[4]: https://cloud.google.com/iam/docs/reference/credentials/rest\n[5]: https://cloud.google.com/iam/docs/reference/sts/rest/v1/TopLevel/token\n[6]: https://cloud.google.com/iam/docs/reference/credentials/rest/v1/projects.serviceAccounts/generateAccessToken\n<!-- prettier-ignore-end -->\n"}