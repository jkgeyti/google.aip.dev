{"text":"---\nid: 165\nstate: approved\ncreated: 2019-12-18\nupdated: 2022-06-02\nplacement:\n  category: design-patterns\n  order: 100\n---\n\n# Criteria-based delete\n\nOccasionally, an API may need to provide a mechanism to delete a large number\nof resources based on some set of filter parameters, rather than requiring the\nindividual resource name of the resources to be deleted.\n\nThis is a rare case, reserved for situations where users need to delete\nthousands or more resources at once, in which case the normal Batch Delete\npattern ([AIP-235][]) becomes unwieldy and inconvenient.\n\n## Guidance\n\n**Important:** Most APIs **should** use only Delete ([AIP-135][]) or Batch\nDelete ([AIP-235][]) for deleting resources, and **should not** implement\ndeleting based on criteria. This is because deleting is generally irreversible\nand this type of operation makes it easy for a user to accidentally lose\nsignificant amounts of data.\n\nAn API **may** implement a Purge method to permit deleting a large number of\nresources based on a filter string; however, this **should** only be done if\nthe Batch Delete ([AIP-235][]) pattern is insufficient to accomplish the\ndesired goal:\n\n```proto\nrpc PurgeBooks(PurgeBooksRequest) returns (google.longrunning.Operation) {\n  option (google.api.http) = {\n    post: \"/v1/{parent=publishers/*}/books:purge\"\n    body: \"*\"\n  };\n  option (google.longrunning.operation_info) = {\n    response_type: \"PurgeBooksResponse\"\n    metadata_type: \"PurgeBooksMetadata\"\n  };\n}\n```\n\n- The RPC's name **must** begin with the word `Purge`. The remainder of the\n  RPC name **should** be the plural form of the resource being purged.\n- The request message **must** match the RPC name, with a `Request` suffix.\n- The response type **must** be a `google.longrunning.Operation` (see\n  AIP-151) that resolves to a message whose name matches the RPC name, with\n  a `Response` suffix.\n- The HTTP verb **must** be `POST`, and the `body` **must** be `\"*\"`.\n- The URI path **should** represent the collection for the resource.\n- The `parent` field **should** be included in the URI. If the API wishes to\n  support deletion across multiple parents, it **should** accept the `-`\n  character consistent with [AIP-159][].\n\n### Request message\n\nPurge methods implement a common request message pattern:\n\n```proto\nmessage PurgeBooksRequest {\n  // The publisher to purge books from.\n  // To purge books across publishers, send \"publishers/-\".\n  string parent = 1 [\n    (google.api.field_behavior) = REQUIRED,\n    (google.api.resource_reference) = {\n      child_type: \"library.googleapis.com/Book\"\n    }];\n\n  // A filter matching the books to be purged.\n  string filter = 2 [(google.api.field_behavior) = REQUIRED];\n\n  // Actually perform the purge.\n  // If `force` is set to false, the method will return a sample of\n  // resource names that would be deleted.\n  bool force = 3;\n}\n```\n\n- A singular `string parent` field **should** be included, unless the resource\n  is top-level.\n  - The field **should** be [annotated as required][aip-203].\n  - The field **should** identify the [resource type][aip-123] that it\n    references.\n- A singular `string filter` field **must** be included and **must** follow the\n  same semantics as in List methods (AIP-160).\n  - It **should** be [annotated as required][aip-203].\n- A singular `bool force` field **must** be included. If it is not set, the API\n  **must** return a count of the resources that would be deleted as well as a\n  sample of those resources, without actually performing the deletion.\n\n### Response message\n\nPurge methods implement a common response message pattern:\n\n```proto\nmessage PurgeBooksResponse {\n  // The number of books that this request deleted (or, if `force` is false,\n  // the number of books that will be deleted).\n  int32 purge_count = 1;\n\n  // A sample of the resource names of books that will be deleted.\n  // Only populated if `force` is set to false.\n  repeated string purge_sample = 2 [(google.api.resource_reference) = {\n    type: \"library.googleapis.com/Book\"\n  }];\n}\n```\n\n- A singular `int32 purge_count` field **should** be included, and provide the\n  number of resources that were deleted (or would be deleted). This count\n  **may** be an estimate similar to `total_size` in AIP-158 (but the service\n  **should** document this if so).\n- A `repeated string purge_sample` field **should** be included: If `force` is\n  `false`, it **should** provide a sample of resource names that will be\n  deleted. If `force` is true, this field **should not** be populated.\n  - The sample **should** be a sufficient size to catch clearly obvious\n    mistakes: A good rule of thumb is 100. The API **should** document the\n    size, and **should** document that it is a maximum (it is possible to send\n    fewer).\n  - The sample **may** be random or **may** be deterministic (such as the first\n    matched resource names). The API **should** document which approach is\n    used.\n  - The field **should** identify the [resource type][aip-123] that it\n    references.\n\n**Note:** Even if `purge_count` and `purge_sample` are not included, the\n`force` field **must** still be included in the request.\n\n## Changelog\n\n- **2022-06-02:** Changed suffix descriptions to eliminate superfluous \"-\".\n- **2020-10-29**: Expanded guidance on HTTP, field behavior, and resource\n  reference annotations.\n\n[aip-123]: ./0123.md\n[aip-135]: ./0135.md\n[aip-159]: ./0159.md\n[aip-203]: ./0203.md\n[aip-235]: ./0235.md\n"}
